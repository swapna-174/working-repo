    select p.PAT_NAME                   Patient
           ,p.PAT_MRN_ID                MRN
           ,readmit_har.HSP_ACCOUNT_ID  "Readmit HAR"
           ,zha.NAME                    "Readmit Har Class"
           ,PriorDischarge.PriorDC      "Prior Discharge"           
           ,readmit_peh.HOSP_ADMSN_TIME "Readmit Admission"
           ,readmit_peh.HOSP_DISCH_TIME "Readmit Discharge"

           ,CASE WHEN Prior_PrimaryDx.Pr_DX_Group IS NOT NULL THEN Prior_PrimaryDx.Pr_DX_Group
                  WHEN Prior_PrimaryDx.Primary_Dx IS NOT NULL THEN UPPER(Prior_PrimaryDx.Primary_Dx)
                    ELSE ' ' END         "Prior Primary DX Group/Dx"
           ,coalesce(zcrace.NAME,' ')    Race
           ,parloc.RPT_GRP_ONE           "Readmit Parent Hospital"
           ,readmit_peh.PAT_ENC_CSN_ID   "Readmit CSN"
           ,PriorDischarge.PriorCSN        "Prior CSN"
           ,p.pat_id                     "Pat ID"
  
    from pat_enc_hsp readmit_peh
          INNER JOIN patient p on readmit_peh.PAT_ID = p.PAT_ID
          CROSS APPLY (
                SELECT PriorPeh.PAT_ENC_CSN_ID PriorCSN
                       , PriorPeh.HOSP_DISCH_TIME PriorDC
                FROM PAT_ENC_HSP PriorPeh 
                  LEFT JOIN hsp_account PriorHAR ON PriorPeh.HSP_ACCOUNT_ID = PriorHAR.HSP_ACCOUNT_ID
                  
                WHERE  trunc(readmit_peh.HOSP_ADMSN_TIME) > trunc(PriorPeh.HOSP_DISCH_TIME)   --current adm after prior dc
                    AND trunc(readmit_peh.HOSP_ADMSN_TIME) <= (trunc(PriorPeh.HOSP_DISCH_TIME) + 30)  --and current
                    --AND PriorHAR.ACCT_CLASS_HA_C IN ('101')  --IP or ED-to_IP       ----  103-ED,104-Obs
                    --AND PriorPeh.ADT_PATIENT_STAT_C <> 6 --EXCLUDE HOVs!
                    AND PriorPeh.PAT_ID = readmit_peh.PAT_ID
                    
                    AND PriorPeh.PAT_ENC_CSN_ID IN (
                            SELECT enc.pat_enc_csn_id
                            FROM ip_flwsht_meas ip_meas               
                              inner join ip_flwsht_rec ip_rec on ip_meas.fsd_id = ip_rec.fsd_id
                              inner join ip_flo_gp_data ip_data on ip_meas.flo_meas_id = ip_data.flo_meas_id
                              inner join ip_flt_data flt on ip_meas.FLT_ID = flt.TEMPLATE_ID
                              inner join pat_enc_hsp enc on ip_rec.INPATIENT_DATA_ID = enc.inpatient_data_id
                            WHERE ip_meas.FLO_MEAS_ID = '3042002849' --Enrollment Start Date
                                  and ip_meas.ISACCEPTED_YN <> 'N'
                             )  --get the latest entry in the encounter
               )PriorDischarge  
     
          LEFT JOIN clarity_dep dep on readmit_peh.DEPARTMENT_ID = dep.DEPARTMENT_ID
            LEFT JOIN clarity_loc loc on dep.REV_LOC_ID = loc.LOC_ID
            LEFT JOIN clarity_loc parloc on loc.HOSP_PARENT_LOC_ID = parloc.LOC_ID
          LEFT JOIN hsp_account readmit_har on readmit_peh.HSP_ACCOUNT_ID = readmit_har.HSP_ACCOUNT_ID
            LEFT JOIN 	ZC_ACCT_CLASS_HA zha on readmit_har.ACCT_CLASS_HA_C = zha.ACCT_CLASS_HA_C
          LEFT JOIN patient_race race on p.PAT_ID = race.pat_ID and race.line = 1 --preferred race
            LEFT JOIN 	ZC_PATIENT_RACE zcrace on race.PATIENT_RACE_C = zcrace.PATIENT_RACE_C     
          
          OUTER APPLY ( SELECT
                              HARDX.HSP_ACCOUNT_ID ,  
                              HARDX.DX_ID, 
                              peh_PRIMDX.PAT_ENC_CSN_ID HAR_CSN,
                              EDG.DX_NAME Primary_Dx,
                               --EDG.CURRENT_ICD10_LIST HFicd10_Primary,
                              EDG.DX_GROUP Pr_DX_Group
                --                      EDG.RECORD_TYPE_C RecType,   --record type of dx record: 1-Term, 2-Code, 3 Both code and term
                --                      EDG.REF_BILL_CODE RBC
                            FROM
                              PAT_ENC_HSP peh_PRIMDX 
                              LEFT JOIN HSP_ACCT_DX_LIST HARDX ON peh_PRIMDX.HSP_ACCOUNT_ID = HARDX.HSP_ACCOUNT_ID AND HARDX.LINE = 1 
                              LEFT JOIN CLARITY_EDG EDG ON HARDX.DX_ID = EDG.DX_ID
                            WHERE peh_PRIMDX.PAT_ENC_CSN_ID = PriorDischarge.PriorCSN
              ) Prior_PrimaryDx   
    where trunc(readmit_peh.HOSP_ADMSN_TIME) >= EPIC_UTIL.EFN_DIN('01-jun-2021') and trunc(readmit_peh.HOSP_ADMSN_TIME) <= (EPIC_UTIL.EFN_DIN('30-jun-2021')+1)
          and readmit_peh.HOSP_DISCH_TIME IS NOT NULL
          and trunc(readmit_peh.HOSP_ADMSN_TIME) > trunc(PriorDischarge.PriorDC)
          and readmit_har.ACCT_CLASS_HA_C = '101'
		  and readmit_peh.ADT_PATIENT_STAT_C <> 6  --exclude HOV
            
