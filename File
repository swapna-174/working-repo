 WITH Accrual AS 
(
SELECT ENROLL_STAT_CHNG.ENROLL_ID,
       MIN (ENROLL_STAT_CHNG.ENROLL_STAT_CHNG_DATE) AccrualDate
  FROM ENROLL_STAT_CHNG INNER JOIN ENROLL_STAT_ACCRUAL
    ON ENROLL_STAT_CHNG.CHNG_ENROLL_STATUS_C = ENROLL_STAT_ACCRUAL.ACCRUAL_ENROLL_STATUS_C
      AND ENROLL_STAT_ACCRUAL.FACILITY_ID = '1'
  GROUP BY ENROLL_STAT_CHNG.ENROLL_ID 
)
SELECT CAST( ENROLL_INFO.ENROLL_ID AS numeric(18,0) ) ENROLLMENTID,
       CAST( ENROLL_INFO.PAT_ID AS varchar(50) ) PATIENTID,
       ENROLL_INFO.ENROLL_START_DT STARTDATE,
       ENROLL_INFO.ENROLL_END_DT ENDDATE,
       CAST( ENROLL_INFO.RESEARCH_STUDY_ID AS varchar(50) ) STUDYID,
       CAST( ENROLL_INFO.STUDY_ALIAS AS varchar(50) ) PATIENTALIAS,
       CAST( CASE WHEN ENROLL_INFO.ENROLL_STATUS_C IS NULL THEN '*Unspecified'
                  WHEN ZC_ENROLL_STATUS.ENROLL_STATUS_C IS NULL THEN '*Unknown'
                  ELSE ZC_ENROLL_STATUS.NAME END AS varchar(300) ) ENROLLMENTSTATUS,
       CAST( CASE WHEN ENROLL_INFO.ENROLL_STATUS_C IS NULL THEN '*Unspecified'
                  WHEN ZC_RSH_ENROLL_STAT_TYPE.RSH_ENROLL_STAT_TYPE_C IS NULL THEN '*Unknown'
                  ELSE ZC_RSH_ENROLL_STAT_TYPE.NAME END AS varchar(300) ) STATUSBUCKET,
       CAST( CASE WHEN ENROLL_INFO.RSH_MYC_STATUS_C IS NULL THEN '*Unspecified'
                  WHEN ZC_RSH_MYC_STATUS.RSH_MYC_STATUS_C IS NULL THEN '*Unknown'
                  ELSE ZC_RSH_MYC_STATUS.NAME END AS varchar(300) ) MYCHARTRECRUITMENTSTATUS,
       CAST( STUDY_BRANCHES.BRANCH_NAME AS varchar(200) ) BRANCHNAME,
       Accrual.AccrualDate ACCRUALDATE,
       ( SELECT CAST( MIN( HX_MOD_DTTM ) AS DATE ) 
           FROM ENROLL_INFO_HX
             WHERE ENROLL_INFO_HX.ENROLL_ID = ENROLL_INFO.ENROLL_ID
               AND ENROLL_INFO_HX.HX_MYCHART_STATUS_C = 3 ) REQUESTFIRSTSENTDATE,
       CASE WHEN ENROLL_INFO.MYC_RESPONSE_TYPE_C IS NULL THEN '*Unspecified'
            WHEN ZC_MYC_RESPONSE_TYPE.MYC_RESPONSE_TYPE_C IS NULL THEN '*Unknown'
            ELSE ZC_MYC_RESPONSE_TYPE.NAME END MYCHARTRESPONSETYPE,
       CASE WHEN ENROLL_INFO.PAT_INITIATED_INTEREST_C IS NULL THEN '*Unspecified'
            WHEN ZC_PAT_INITIATED_INTEREST.PAT_INITIATED_INTEREST_C IS NULL THEN '*Unknown'
            ELSE ZC_PAT_INITIATED_INTEREST.NAME END PATIENTINITIATEDINTEREST
  FROM ENROLL_INFO 
    LEFT OUTER JOIN ZC_ENROLL_STATUS
      ON ENROLL_INFO.ENROLL_STATUS_C = ZC_ENROLL_STATUS.ENROLL_STATUS_C
    LEFT OUTER JOIN ZC_RSH_MYC_STATUS
      ON ENROLL_INFO.RSH_MYC_STATUS_C = ZC_RSH_MYC_STATUS.RSH_MYC_STATUS_C
    LEFT OUTER JOIN STUDY_BRANCHES 
      ON ENROLL_INFO.RESEARCH_STUDY_ID = STUDY_BRANCHES.RESEARCH_ID
        AND ENROLL_INFO.STUDY_BRANCH_ID = STUDY_BRANCHES.BRANCH_ID
    LEFT OUTER JOIN ZC_PAT_INITIATED_INTEREST
      ON ENROLL_INFO.PAT_INITIATED_INTEREST_C = ZC_PAT_INITIATED_INTEREST.PAT_INITIATED_INTEREST_C 
    LEFT OUTER JOIN ENROLL_STAT_ACTV 
      ON ENROLL_INFO.ENROLL_STATUS_C = ENROLL_STAT_ACTV.RSH_ENR_STAT_ACT_C
        AND ENROLL_STAT_ACTV.FACILITY_ID = '1'
    LEFT OUTER JOIN ENROLL_STAT_PRE 
      ON ENROLL_INFO.ENROLL_STATUS_C = ENROLL_STAT_PRE.RSH_ENR_STAT_PRE_C
        AND ENROLL_STAT_PRE.FACILITY_ID = '1'  
    LEFT OUTER JOIN ZC_RSH_ENROLL_STAT_TYPE
      ON CASE WHEN ENROLL_STAT_ACTV.RSH_ENR_STAT_ACT_C IS NOT NULL THEN 1
              WHEN ENROLL_STAT_PRE.RSH_ENR_STAT_PRE_C IS NOT NULL THEN 2
              ELSE 0 END = ZC_RSH_ENROLL_STAT_TYPE.RSH_ENROLL_STAT_TYPE_C
    LEFT OUTER JOIN Accrual
      ON ENROLL_INFO.ENROLL_ID = Accrual.ENROLL_ID
    LEFT OUTER JOIN ZC_MYC_RESPONSE_TYPE
      ON ZC_MYC_RESPONSE_TYPE.MYC_RESPONSE_TYPE_C = ENROLL_INFO.MYC_RESPONSE_TYPE_C
  WHERE ENROLL_INFO.RECORD_STATUS_C IS NULL 
    AND ENROLL_INFO.ENROLL_ID > {{LowerBound}}
    AND ENROLL_INFO.ENROLL_ID <= {{UpperBound}}  
