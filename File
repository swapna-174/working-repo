SELECT DISTINCT
    pt.PAT_ID AS "ControlNo",
    enc.PAT_ENC_CSN_ID AS "EncounterID",
    enc.CONTACT_DATE AS "Encounter Date",
    patins.SUBSCRIBER_ID AS "Primary Insurance ID",
    pt.PATIENT_L_NAME AS "Patient Last Name",
    pt.PATIENT_F_NAME AS "Patient First Name",
    pt.BIRTH_DATE AS "Patient DOB",
    grp_plan.GROUP_NAME AS "Insurance Group",
    plan.PLAN_NAME AS "Primary Insurance Name",
    patins.SUBSCRIBER_ID AS "Primary Insurance Subscriber Number",
    prov.PROVIDER_L_NAME + ', ' + prov.PROVIDER_F_NAME AS "Provider Name",
    prov.NPI AS "NPI",
    enc.DSCH_DATE AS "Date of Discharge",
    outreach_obs.VALUE_DATE AS "Date of Interactive Outreach",
    f2f_obs.VALUE_DATE AS "Face to Face Scheduled",
    meds_obs.VALUE_DATE AS "Medications Reconciled Post Acute",
    hosp_enc.HOSP_FU_DATE AS "Hospital FU Date",
    doclog.DOC_USER_NAME AS "Documenting Staff"
    
FROM 
    CLARITY_PATIENT pt
    JOIN CLARITY_PAT_ENC enc ON pt.PAT_ID = enc.PAT_ID
    LEFT JOIN CLARITY_SER prov ON prov.PROV_ID = enc.PROV_ID
    LEFT JOIN CLARITY_PAT_INS patins ON pt.PAT_ID = patins.PAT_ID AND patins.SEQ_NO = 1
    LEFT JOIN CLARITY_PLAN plan ON plan.PLAN_ID = patins.PLAN_ID
    LEFT JOIN CLARITY_GRP_PLAN grp_plan ON grp_plan.GRP_PLAN_ID = patins.GRP_PLAN_ID

    -- Discharge and social history data
    LEFT JOIN (SELECT PAT_ENC_CSN_ID, VALUE_DATE FROM OBSERVATION_FACT WHERE ITEM_ID = 5345) DtofDischarge ON DtofDischarge.PAT_ENC_CSN_ID = enc.PAT_ENC_CSN_ID
    LEFT JOIN (SELECT PAT_ENC_CSN_ID, VALUE_DATE FROM OBSERVATION_FACT WHERE ITEM_ID = 5346) outreach_obs ON outreach_obs.PAT_ENC_CSN_ID = enc.PAT_ENC_CSN_ID
    LEFT JOIN (SELECT PAT_ENC_CSN_ID, VALUE_DATE FROM OBSERVATION_FACT WHERE ITEM_ID = 5347) f2f_obs ON f2f_obs.PAT_ENC_CSN_ID = enc.PAT_ENC_CSN_ID
    LEFT JOIN (SELECT PAT_ENC_CSN_ID, VALUE_DATE FROM OBSERVATION_FACT WHERE ITEM_ID = 5348) meds_obs ON meds_obs.PAT_ENC_CSN_ID = enc.PAT_ENC_CSN_ID
    
    -- Hospital follow-up
    LEFT JOIN (SELECT CONTACT_DATE AS HOSP_FU_DATE, PAT_ID, PAT_ENC_CSN_ID FROM CLARITY_PAT_ENC WHERE ENC_TYPE = 'Hosp F/U') hosp_enc ON hosp_enc.PAT_ID = pt.PAT_ID
    
    -- Documenting staff logs
    LEFT JOIN (SELECT PAT_ENC_CSN_ID, USER_L_NAME + ', ' + USER_F_NAME AS "Documenting Staff" FROM DOCUMENTATION_LOG WHERE ACTION_FLAG = 4) doclog ON doclog.PAT_ENC_CSN_ID = enc.PAT_ENC_CSN_ID
    
WHERE 
    outreach_obs.VALUE_DATE BETWEEN DATEADD(DAY, -7, CAST(GETDATE() AS DATE)) AND DATEADD(DAY, -1, CAST(GETDATE() AS DATE))
    AND enc.ENC_TYPE = 2
    AND enc.DELETE_FLAG = 0
    AND pt.PATIENT_L_NAME NOT LIKE 'zzz%'
    AND (grp_plan.GROUP_NAME IN ('Cigna', 'Medicare') 
        OR plan.PLAN_NAME LIKE '%Cigna%' 
        OR plan.PLAN_NAME LIKE '%UHC%')
    AND ((CASE WHEN DtofDischarge.VALUE_DATE IS NULL THEN 0 ELSE 1 END) +
        (CASE WHEN outreach_obs.VALUE_DATE IS NULL THEN 0 ELSE 1 END) +
        (CASE WHEN f2f_obs.VALUE_DATE IS NULL THEN 0 ELSE 1 END) +
        (CASE WHEN meds_obs.VALUE_DATE IS NULL THEN 0 ELSE 1 END)) > 0;
